# linux-onedrive-backup webapp

A tool that can be used to compare SHA1 hashes computed locally and by OneDrive to verify
that files uploaded via OneDrive's Web UI were stored properly. Based on the following sample
app from Microsoft: https://github.com/Azure-Samples/ms-identity-python-webapp 

The tool is a Python Flask webapp that can be run locally on your laptop etc. After logging
into your Microsoft account and gaining permission to read your user data and OneDrive files,
it allows you to browse your OneDrive folder structure using Microsoft Graph APIs.

In each folder diplayed, the webapp shows the SHA1 hashes computed by OneDrive and the
corresponding filenames in the same format produced by `sha1sum` when you run it on the same
files locally, allowing for an easy comparison using `git diff`.

Note that the app is registered and entirely controlled by you so while there is some setup
involved it doesn't allow anyone else to access your data.

**The webapp provides an unencrypted http (i.e. not https) interface and as such I strongly
recommend that it only be run and accessed locally.**

## Setup

1. Use your Microsoft login and register an app as per the instructions under Step 2 and
   Step 3 at: https://github.com/Azure-Samples/ms-identity-python-webapp/blob/master/README.md

   * Login to the Azure portal using your personal Microsoft account
   * Register a new application that supports all accounts (organisational and personal)
     and has the following redirect URI: `http://localhost:5000/getAToken`
   * On the overview page record the following ids: Application (client) ID, Directory (tenant) ID
   * Create a new client secret (as per the instructions) with a 1 year expiry and record it
   * Give the app the following Microsoft Graph API 'delegated' permissions (as 
     per the instructions): User.Read, User.ReadBasic.All, Files.Read

1. Clone this repository:

   `$ git clone https://github.com/shreepads/linux-onedrive-backup.git`
   
1. cd into the directory, create a Python 3 virtual environment and activate it:

   `$ cd linux-onedrive-backup`
   
   `$ python3 -m venv venv`
   
   `$ source venv/bin/activate`
   
1. cd into the webapp folder and install the requirements

   `(venv)$ pip install -r requirements.txt`
   

## Run

1. cd into the webapp/ folder and check the virtual environment is active

1. Setup the App/ Client Id, App/ Client Secret and Directory/ Tenant Id as environment variables

   `(venv)$ export CLIENT_ID=<App/ Client Id recorded>`
   
   `(venv)$ read CLIENT_SECRET`
   Enter the App/ Client secret.
   
   `(venv)$ export CLIENT_SECRET`

   `(venv)$ export TENANT_ID=<Directory/ Tenant Id recorded>`
   
1. Optionally, set the logging level to one supported by the logging module
   (https://docs.python.org/3/library/logging.html#levels). The default level is `INFO`.

   `(venv)$ export LOG_LEVEL=DEBUG`

1. Run the webapp

   `(venv)$ flask run --host localhost --port 5000`
   
1. Open the app in your browser: http://localhost:5000

1. Click on the 'Sign In' link. Sign-in and provide consent for your app to access your
   Microsoft account details (only needed the first time)

1. Click on the 'OneDrive files' link and subsequent links to navigate to the folder where
   the split gpg files are stored

1. The app displays the SHA1 hashes (generated by OneDrive and stored in the file object
   metadata) and filenames of all files in the folder in the format produced by `sha1sum`
   
1. Copy and save the information (hash-filename pairs) to a .txt file e.g. 
   `onedrive-important-2020-03-30-sha1s.txt`

1. Compare the SHA1 hashes reported from OneDrive with those generated in Step 3 of the Backup
   process (documented in the main README)

   `git diff onedrive-important-2020-03-30-sha1s.txt important-2020-03-30-sha1sums.txt`
